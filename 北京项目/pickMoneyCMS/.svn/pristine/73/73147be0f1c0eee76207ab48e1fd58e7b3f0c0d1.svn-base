<?php
/**
 * 趣味游戏-福利彩票馆.
 * User: Jason
 * Date: 18/9/17
 * Time: 上午11:49
 */
namespace app\admin\controller\game;

use app\admin\controller\BaseController;

use app\admin\model\game\GameModel;

class Lottery extends BaseController
{
    protected $game_model;
    protected $game_id = 2;//福利彩票馆ID
    protected function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub
        $this->game_model = new GameModel();
    }
    //红包规则设置
    public function home()
    {
        //再来一次次数
        $game_config = $this->game_model->getGameConfigPro($this->game_id,'again_count');
        //免费抽奖弹窗广告+红包配置
        $ad_prize_config = $this->game_model->getGameAdPrizeList($this->game_id);

        $this->assign('ad_prize_config',$ad_prize_config);
        $this->assign('again_times',$game_config['again_count']);

        return $this->fetch();
    }

    //奖品规则说明配置
    public function prize_config()
    {

    }

    //中奖纪录
    public function award_record()
    {

    }

    //更新配置
    public function up_config()
    {
        $data = $this->request_param;
        if (!isset($data['config_list']) || empty($data['config_list'])){
            return json(['status'=>0,'msg'=>'缺少参数']);
        }

        if (!isset($data['again_times']) || empty($data['again_times'])){
            return json(['status'=>0,'msg'=>'缺少参数']);
        }

        //广告占比数据更新
        $weight_sum = 0;
        if (is_array($data['config_list'])) {
            foreach ($data['config_list'] as $one){
                //占比配置数据求和
                $weight_sum += $one['weight'];
            }

            if ($weight_sum > 100){
                return json(['status'=>0,'msg'=>'请输入正确的占比设定']);
            } else {
                foreach ($data['config_list'] as $one){
                    $this->game_model->upGameAdPrizeConfig($one['id'],['p_weight'=>$one['weight']]);
                }
            }
        }
        // 再来一次的次数更新
        $up_config_data['again_count'] = $data['again_times'];
        $up_config_res = $this->game_model->upConfig($up_config_data,$this->game_id);
        if ($up_config_res) {
            return json(['status'=>1,'msg'=>'更新成功']);
        } else {
            return json(['status'=>0,'msg'=>'更新失败']);
        }

    }
}